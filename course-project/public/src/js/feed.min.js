const sharedMomentsArea=document.querySelector("#shared-moments"),shareImageButton=document.querySelector("#share-image-button"),createPostArea=document.querySelector("#create-post"),closeCreatePostModalButton=document.querySelector("#close-create-post-modal-btn"),form=document.querySelector("form"),titleInput=document.querySelector("#title"),locationInput=document.querySelector("#location"),videoPlayer=document.querySelector("#player"),canvasElement=document.querySelector("#canvas"),captureButton=document.querySelector("#capture-btn"),imagePicker=document.querySelector("#image-picker"),imagePickerArea=document.querySelector("#pick-image"),locationBtn=document.querySelector("#location-btn"),locationLoader=document.querySelector("#location-loader");let picture,fetchedLocation={lat:0,lng:0};function initializeLocation(){"geolocation"in navigator||(location.style.display="none")}function initializeMedia(){"mediaDevices"in navigator||(navigator.mediaDevices={}),"getUserMedia"in navigator.mediaDevices||(navigator.mediaDevices.getUserMedia=a=>{const o=navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return o?new Promise((e,t)=>{o.call(navigator,a,e,t)}):Promise.reject(new Error("getUserMedia is not available"))}),navigator.mediaDevices.getUserMedia({video:!0}).then(e=>{videoPlayer.stream=e,videoPlayer.style.display="block"}).catch(e=>imagePickerArea.style.display="block")}function openCreatePostModal(){setTimeout(()=>{createPostArea.style.transform="translateY(0)"},50),initializeMedia(),initializeLocation()}function closeCreatePostModal(){imagePickerArea.style.display="none",videoPlayer.style.display="none",canvasElement.style.display="none",locationBtn.style.display="inline",locationLoader.style.display="none",captureButton.style.display="inline",videoPlayer.srcObject&&videoPlayer.srcObject.getVideoTracks().forEach(e=>e.stop()),setTimeout(()=>{createPostArea.style.transform="translateY(100vh)"},50)}function onSaveButtonClicked(e){console.log("Clicked"),"caches"in window&&caches.open("user-request").then(e=>{e.add("https://httpbin.org/get"),e.add("/src/images/sf-boat.jpg")})}function clearCards(){for(;sharedMomentsArea.hasChildNodes();)sharedMomentsArea.removeChild(sharedMomentsArea.lastChild)}function createCard(e){var t=document.createElement("div"),a=(t.className="shared-moment-card mdl-card mdl-shadow--2dp",document.createElement("div")),o=(a.className="mdl-card__title",a.style.backgroundImage=`url('${e.image}')`,a.style.backgroundSize="cover",t.appendChild(a),document.createElement("h2")),a=(o.style.color="white",o.className="mdl-card__title-text",o.textContent=e.title,a.appendChild(o),document.createElement("div"));a.className="mdl-card__supporting-text",a.textContent=e.location,a.style.textAlign="center",t.appendChild(a),componentHandler.upgradeElement(t),sharedMomentsArea.appendChild(t)}function updateUI(t){clearCards();for(let e=0;e<t.length;e++)createCard(t[e])}locationBtn.addEventListener("click",e=>{let t=!1;"geolocation"in navigator&&(locationBtn.style.display="none",locationLoader.style.display="block",navigator.geolocation.getCurrentPosition(e=>{locationBtn.style.display="inline",locationLoader.style.display="none",fetchedLocation={lat:e.coords.latitude,lng:e.coords.longitude},locationInput.value="test location",document.querySelector("#manual-location").classList.add("is-focused")},e=>{console.log(e),locationBtn.style.display="inline",locationLoader.style.display="none",t||(t=!0,alert("Coundn't fetch locaation, please enter manually.")),fetchedLocation={lat:0,lng:0}},{timeout:7e3}))}),captureButton.addEventListener("click",e=>{canvasElement.style.display="block",videoPlayer.style.display="none",captureButton.style.display="none",canvasElement.getContext("2d").drawImage(videoPlayer,0,0,canvasElement.width,videoPlayer.videoHeight/(videoPlayer.videoWidth/canvasElement.width)),videoPlayer.srcObject.getVideoTracks().forEach(e=>e.stop()),picture=dataURItoBlob(canvasElement.toDataURL())}),imagePicker.addEventListener("change",e=>{picture=e.target.files[0]}),shareImageButton.addEventListener("click",openCreatePostModal),closeCreatePostModalButton.addEventListener("click",closeCreatePostModal);const url="https://teste-d4240-default-rtdb.firebaseio.com/posts.json";let networkDataReceived=!1;function sendData(){var e=new FormData,t=new Date.toISOString;e.append("id",t),e.append("title",titleInput.value),e.append("location",locationInput.value),e.append("rawLocationLng",fetchedLocation.lng),e.append("rawLocationLat",fetchedLocation.lat),e.append("file",picture,t+".png"),fetch("https://us-central1-teste-d4240.cloudfunctions.net/storePostData",{method:"POST",body:e}).then(e=>{console.log("Sent data",e),updateUI()})}fetch(url).then(e=>e.json()).then(e=>{networkDataReceived=!0,console.log("From Web",e);var t,a=[];for(t in e)a.push(e[t]);updateUI(a)}),"indexedDB"in window&&readAllData("posts").then(e=>{networkDataReceived||(console.log("From cache",e),updateUI(e))}),form.addEventListener("submit",e=>{e.preventDefault(),""===titleInput.value.trim()||""===locationInput.value.trim()?alert("Please, enter a valid data."):(closeCreatePostModal(),"serviceWorker"in navigator&&"SyncManager"in window?navigator.serviceWorker.ready.then(e=>{var t={id:(new Date).toISOString(),title:titleInput.value,location:locationInput.value,picture:picture,rawLocation:fetchedLocation};writeData("sync-posts",t).then(()=>e.sync.register("sync-new-posts")).then(()=>{document.querySelector("#confirmation-toast").MaterialSnackbar.showSnackbar({message:"Your post was saved for syncing"})}).catch(e=>console.log(e))}):sendData())});